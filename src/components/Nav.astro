---
import { useTranslations } from '../i18n/utils';
const lang = Astro.currentLocale || 'en';
const t = useTranslations(lang);

const base = lang === 'en' ? '' : `/${lang}`;

const links = [
  { href: `${base}/#about`, label: t('nav.about') },
  { href: `${base}/#experience`, label: t('nav.experience') },
  { href: `${base}/#education`, label: t('nav.education') },
  { href: `${base}/#projects`, label: t('nav.projects') },
  { href: `${base}/#skills`, label: t('nav.skills') },
  { href: `${base}/#awards`, label: t('nav.awards') },
  { href: `${base}/blog`, label: t('nav.articles') },
  { href: `${base}/#contact`, label: t('nav.contact') },
];

const locales = [
  { code: 'en', label: 'ðŸ‡¬ðŸ‡§ EN', flag: 'ðŸ‡¬ðŸ‡§' },
  { code: 'it', label: 'ðŸ‡®ðŸ‡¹ IT', flag: 'ðŸ‡®ðŸ‡¹' },
  { code: 'fr', label: 'ðŸ‡«ðŸ‡· FR', flag: 'ðŸ‡«ðŸ‡·' }
];

const currentLocale = locales.find(l => l.code === lang) || locales[0];

// Helper to construct exact same path in different language
const currentPath = Astro.url.pathname;
const cleanPath = currentPath.replace(/^\/(it|fr)(\/|$)/, '/').replace(/\/$/, '');
---

<!-- Mobile menu overlay -->
<div id="mobile-menu" class="fixed inset-0 z-40 bg-bg-primary/95 backdrop-blur-xl md:hidden -translate-y-full transition-transform duration-500 flex flex-col items-center justify-center gap-8">
  {
    links.map((link) => (
      <a
        href={link.href}
        class="mobile-nav-link text-2xl font-semibold text-text-secondary hover:text-accent-blue transition-colors duration-300 transform hover:scale-110"
      >
        {link.label}
      </a>
    ))
  }
</div>

<nav
  id="navbar"
  class="fixed top-0 left-0 right-0 z-50 px-4 md:px-0"
>
  <div class="glass mx-auto max-w-5xl mt-4 rounded-2xl px-6 py-3">
    <div class="flex items-center justify-between">
      <a href="/#" class="font-mono text-sm font-bold gradient-text">AM</a>

      <!-- Desktop links -->
      <div class="hidden md:flex items-center gap-6">
        {
          links.map((link) => (
            <a
              href={link.href}
              class="nav-link text-sm text-text-secondary hover:text-accent-blue transition-colors duration-300"
            >
              {link.label}
            </a>
          ))
        }
      </div>

      <!-- Mobile hamburger -->
      <div class="md:hidden flex items-center gap-4">
        <div class="relative group">
          <button class="font-mono text-sm text-text-secondary hover:text-accent-blue transition-colors flex items-center gap-2">
            <span>{currentLocale.flag}</span> <span class="hidden sm:inline">{lang.toUpperCase()}</span>
          </button>
          <div class="absolute right-0 top-full mt-2 w-16 bg-bg-primary border border-border-glass rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300">
            {locales.filter(l => l.code !== lang).map(l => (
              <a 
                href={l.code === 'en' ? (cleanPath || '/') : `/${l.code}${cleanPath || ''}`}
                class="block w-full text-center py-2 px-2 text-sm text-text-secondary hover:text-accent-blue hover:bg-white/5 transition-colors font-mono"
              >
                {l.flag} {l.code.toUpperCase()}
              </a>
            ))}
          </div>
        </div>

        <button
          id="menu-toggle"
          class="relative z-50 flex flex-col gap-1.5 p-2"
          aria-label="Toggle menu"
        >
          <span class="block w-5 h-0.5 bg-text-primary transition-all duration-300 origin-center" id="bar1"></span>
          <span class="block w-5 h-0.5 bg-text-primary transition-all duration-300" id="bar2"></span>
          <span class="block w-5 h-0.5 bg-text-primary transition-all duration-300 origin-center" id="bar3"></span>
        </button>
      </div>

      <!-- Language Switcher Desktop -->
      <div class="hidden md:flex items-center gap-3 relative group ml-2">
        <button class="font-mono text-sm text-text-secondary hover:text-accent-blue transition-colors flex items-center gap-2">
          <span>{currentLocale.flag}</span> <span>{lang.toUpperCase()}</span>
          <svg class="w-3 h-3 group-hover:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div class="absolute right-0 top-full mt-2 w-16 bg-bg-primary border border-border-glass rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 flex flex-col">
          {locales.filter(l => l.code !== lang).map(l => (
            <a 
                href={l.code === 'en' ? (cleanPath || '/') : `/${l.code}${cleanPath || ''}`}
                class="block w-full text-center py-2 px-2 text-sm text-text-secondary hover:text-accent-blue hover:bg-white/5 transition-colors font-mono"
            >
              {l.flag} {l.code.toUpperCase()}
            </a>
          ))}
        </div>
      </div>
    </div>
  </div>
</nav>

<script>
  const navbar = document.getElementById('navbar')!;
  const toggle = document.getElementById('menu-toggle')!;
  const mobileMenu = document.getElementById('mobile-menu')!;
  const bar1 = document.getElementById('bar1')!;
  const bar2 = document.getElementById('bar2')!;
  const bar3 = document.getElementById('bar3')!;
  let menuOpen = false;

  // Active section tracking
  const sections = document.querySelectorAll('section[id]');
  const navLinks = document.querySelectorAll('.nav-link, .mobile-nav-link');

  const sectionObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          navLinks.forEach((link) => {
            link.classList.remove('text-accent-blue');
            link.classList.add('text-text-secondary');
            
            // Note: Since links now have /#id, we need to extract the id
            const href = link.getAttribute('href');
            if (href && href.endsWith(`#${entry.target.id}`)) {
              link.classList.add('text-accent-blue');
              link.classList.remove('text-text-secondary');
            }
          });
        }
      });
    },
    { threshold: 0.3 }
  );

  sections.forEach((section) => sectionObserver.observe(section));

  // Mobile menu toggle
  toggle.addEventListener('click', () => {
    menuOpen = !menuOpen;
    if (menuOpen) {
      mobileMenu.classList.remove('-translate-y-full');
      mobileMenu.classList.add('translate-y-0');
      bar1.style.transform = 'rotate(45deg) translate(3px, 3px)';
      bar2.style.opacity = '0';
      bar3.style.transform = 'rotate(-45deg) translate(3px, -3px)';
    } else {
      mobileMenu.classList.remove('translate-y-0');
      mobileMenu.classList.add('-translate-y-full');
      bar1.style.transform = '';
      bar2.style.opacity = '1';
      bar3.style.transform = '';
    }
  });

  // Close mobile menu on link click
  document.querySelectorAll('.mobile-nav-link').forEach((link) => {
    link.addEventListener('click', () => {
      menuOpen = false;
      mobileMenu.classList.remove('translate-y-0');
      mobileMenu.classList.add('-translate-y-full');
      bar1.style.transform = '';
      bar2.style.opacity = '1';
      bar3.style.transform = '';
    });
  });
</script>
